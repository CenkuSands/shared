#!/bin/bash

# Kafka bootstrap server
BOOTSTRAP_SERVER="localhost:9092"

# Get the list of all topics
TOPICS=$(kafka-topics.sh --bootstrap-server $BOOTSTRAP_SERVER --list)

# Iterate over each topic
for TOPIC in $TOPICS
do
  echo "Topic: $TOPIC"
  
  # Get the partitions for each topic
  PARTITIONS=$(kafka-topics.sh --bootstrap-server $BOOTSTRAP_SERVER --describe --topic $TOPIC | grep "Partition:" | awk '{print $2}')

  # Iterate over each partition
  for PARTITION in $PARTITIONS
  do
    # Fetch the log directory information for each partition
    LOG_DIR_INFO=$(kafka-log-dirs.sh --bootstrap-server $BOOTSTRAP_SERVER --describe --topic-list $TOPIC --partitions $PARTITION | grep -A 6 $PARTITION)
    
    # Extract the last modified timestamp (high water mark offset time)
    LAST_MODIFIED=$(echo "$LOG_DIR_INFO" | grep "Offset:" | awk '{print $3}')
    
    # Convert the high watermark offset time to human-readable format
    LAST_MODIFIED_HUMAN=$(date -d @$((LAST_MODIFIED/1000)) +"%Y-%m-%d %H:%M:%S")
    
    echo "Partition: $PARTITION - Last Modified: $LAST_MODIFIED_HUMAN"
  done

  echo ""
done
