#!/bin/bash

# Kafka binaries path
KAFKA_HOME="/path/to/kafka/bin"

# Kafka broker address
BROKER="localhost:9092"

# Function to get the last log timestamp of a topic
get_last_update_date() {
  local topic=$1

  # Get the partitions for the topic
  partitions=$($KAFKA_HOME/kafka-topics.sh --describe --topic $topic --bootstrap-server $BROKER | grep "Partition:" | awk '{print $2}')

  last_update_timestamp=0

  # Loop through each partition and get the offset timestamp
  for partition in $partitions; do
    # Get the latest offset timestamp using offsetsForTimes
    timestamp=$($KAFKA_HOME/kafka-run-class.sh kafka.tools.GetOffsetShell --broker-list $BROKER --time -1 --topic $topic --partition $partition | awk -F: '{print $3}')

    if [[ $timestamp -gt $last_update_timestamp ]]; then
      last_update_timestamp=$timestamp
    fi
  done

  # Convert the timestamp to a human-readable date
  if [[ $last_update_timestamp -gt 0 ]]; then
    date -d @$((last_update_timestamp / 1000))
  else
    echo "No updates found"
  fi
}

# Get all topics
topics=$($KAFKA_HOME/kafka-topics.sh --list --bootstrap-server $BROKER)

echo "Last update date for each topic:"
for topic in $topics; do
  echo -n "$topic: "
  get_last_update_date $topic
done
